<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- This is an SEO Change, making title more descriptive -->
    <title>Personal Budget App | Free Personal Budget and Finance Planning App</title>
    <meta name="description" content="A free personal budget app to track expenses, set alerts, and manage your money.">
    <meta name="keywords" content="app free budget finance">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="main.css">

    <!-- This is an SEO Change, Open graph makes the site appear good on social media, and increased clicks and visits -->
    <meta property="og:title"
        content="A free personal budget app to track expenses, set alerts, and manage your money.">
    <meta property="og:description"
        content="Free personal budget app to track expenses, set alerts, and manage your money smarter.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://127.0.0.1:3000/personal-budget/index.html">
    <meta property="og:image" content="http://127.0.0.1:3000/personal-budget/bg.png">

</head>

<body>

    <a href="#main" class="skip">Skip to content</a>


    <!-- This is a Semantic HTML Change -->
    <!-- Enclosing the nav and div within a header element -->

    <!-- This is an A11y Change. Adding role for landmarks -->
    <header role="banner">
        <nav>
            <ul>
                <!-- This is an A11y Change. Helping users know which page they are currently on. -->
                <li><a href="/pb/" aria-current="page">Home</a></li>
                <li><a href="./about.html">About</a></li>
                <!-- This is a Semantic HTML Change -->
                <!-- Added a dot character to make login as a relative path to the file -->
                <li><a href="./login.html">Login</a></li>
                <li><a href="https://google.com">Google</a></li>
            </ul>
        </nav>

        <div class="hero">
            <h1>Personal Budget</h1>
            <h2>A personal-budget management app</h2>
        </div>
    </header>

    <!-- This is an A11y Change. Adding role for landmarks -->
    <main role="main" class="center" id="main">

        <div class="page-area">

            <article>
                <!-- This is a Semantic HTML Change -->
                <!-- Replacing h1 with h2 tag, because this page already has an h1 header -->
                <h2>Stay on track</h2>
                <p>
                    Do you know where you are spending your money? If you really stop to track it down,
                    you would get surprised! Proper budget management depends on real data... and this
                    app will help you with that!
                </p>
            </article>

            <article>
                <h2>Alerts</h2>
                <p>
                    What if your clothing budget ended? You will get an alert. The goal is to never go over the budget.
                </p>
            </article>

            <article>
                <h2>Results</h2>
                <p>
                    People who stick to a financial plan, budgeting every expense, get out of debt faster!
                    Also, they to live happier lives... since they expend without guilt or fear...
                    because they know it is all good and accounted for.
                </p>
            </article>

            <article>
                <h2>Free</h2>
                <p>
                    This app is free!!! And you are the only one holding your data!
                </p>
            </article>

            <!-- This is an A11y Change. Removed duplicated articles. -->

            <!-- <article>
                <h2>Stay on track</h2>
                <p>
                    Do you know where you are spending your money? If you really stop to track it down,
                    you would get surprised! Proper budget management depends on real data... and this
                    app will help you with that!
                </p>
            </article>
    
            <article>
                <h2>Alerts</h2>
                <p>
                    What if your clothing budget ended? You will get an alert. The goal is to never go over the budget.
                </p>
            </article>
    
            <article>
                <h2>Results</h2>
                <p>
                    People who stick to a financial plan, budgeting every expense, get out of debt faster!
                    Also, they to live happier lives... since they expend without guilt or fear... 
                    because they know it is all good and accounted for.
                </p>
            </article> -->

            <article>
                <h2>Chart</h2>
                <!-- This is a Semantic HTML Change -->
                <!-- <p> element is replaced with figure, because this is the correct semantic tag for a chart or picture. 
                    Also added a label. -->
                <figure>
                    <canvas id="myChart" width="800" height="800" aria-label="Personal Budget Chart"></canvas>

                    <!-- This is an SEO Change. Adding figure caption to give a context to the search engines. -->
                    <figcaption class="chartcaption">A pie chart displaying budget categories and their allocations.
                    </figcaption>

                </figure>
            </article>

            <article>
               
            </article>

        </div>
        <div >
             <h2>D3 Chart</h2>
                <figure id="d3-chart-container" aria-label="Personal Budget D3 Chart">
                    <!-- D3 will append its SVG here -->
                    <figcaption class="chartcaption">
                        D3 pie chart
                    </figcaption>
                </figure>
        </div>

    </main>

    <!-- This is an A11y Change. Adding role for landmarks -->
    <footer role="contentinfo" class="bottom">
        <div class="center">
            All rights reserved &copy; Pavithra Selvan
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js"
        integrity="sha512-h9644v03pHqrIHThkvXhB2PJ8zf5E9IyVnrSfZg8Yj8k4RsO4zldcQc4Bi9iVLUCCsqNY0b4WXVV4UB+wbWENA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"
        integrity="sha512-G8JE1Xbr0egZE5gNGyUm1fF764iHVfRXshIoUWCTPAbKkkItp/6qal5YAHXrxEu4HNfPTQs6HOu3D5vCGS1j3w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var dataSource = {
            datasets: [
                {
                    data: [],
                    backgroundColor: [
                        '#ffcd56', // yellow
                        '#ff6384', // pink/red
                        '#36a2eb', // blue
                        '#fd6b19', // orange
                        '#4bc0c0', // teal (instead of light cyan)
                        '#9966ff', // purple (instead of light blue)
                        '#2ecc71', // green (instead of honeydew)
                        '#20b2aa', // teal/sea green (instead of mint)
                        '#ff7f7f', // salmon/red (instead of misty rose)
                        '#c71585', // violet/purple (instead of lavender blush)
                        '#d2691e'  // chocolate/brown (instead of linen)
                    ]
                }
            ],
            labels: []
        };

        function createChart() {
            var ctx = document.getElementById('myChart').getContext('2d');
            var myPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: dataSource
            });
        }

        function getBudget() {
            axios.get('/budget')
                .then(function (res) {
                    console.log(res);
                    for (var i = 0; i < res.data.myBudget.length; i++) {
                        dataSource.datasets[0].data[i] = res.data.myBudget[i].budget;
                        dataSource.labels[i] = res.data.myBudget[i].title;
                    }
                    createChart();
                });
        }

        getBudget();
        // createChart();
    </script>



    <!-- Adding an additional D3 JS chart for the Budget Data -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>

        // var svg = d3.select("body")
        //     .append("svg")
        //     .append("g")

        var svg = d3.select("#d3-chart-container")
            .append("svg")
            .attr("width", 340)
            .attr("height", 340)
            .append("g");

        svg.append("g")
            .attr("class", "slices");
        svg.append("g")
            .attr("class", "labels");
        svg.append("g")
            .attr("class", "lines");

        var width = 800,
            height = 400,
            radius = Math.min(width, height) / 2;

        var pie = d3.layout.pie()
            .sort(null)
            .value(function (d) {
                return d.value;
            });

        var arc = d3.svg.arc()
            .outerRadius(radius * 0.8)
            .innerRadius(radius * 0.4);

        var outerArc = d3.svg.arc()
            .innerRadius(radius * 0.9)
            .outerRadius(radius * 0.9);

        svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var key = function (d) { return d.data.label; };

        var color = d3.scale.ordinal()
            .domain(["Lorem ipsum", "dolor sit", "amet", "consectetur", "adipisicing", "elit", "sed", "do", "eiusmod", "tempor", "incididunt"])
            .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

        // function budgetData() {
        //     var labels = color.domain();
        //     return labels.map(function (label) {
        //         return { label: label, value: Math.random() }
        //     });

        //     var labels = dataSource.datasets
        // }

        function getBudgetData() {
            return axios.get('/budget')
                .then(function (res) {
                    const budgetdata_d3 = res.data.myBudget.map(item => ({
                        label: item.title,
                        value: item.budget
                    }));
                    return budgetdata_d3;
                })
                .catch(function (err) {
                    console.error('Error fetching budget data:', err);
                    return [];
                });
        }

        getBudgetData().then(function (budgetdata_d3) {
            console.log(budgetdata_d3); // array of objects
            change(budgetdata_d3);      // draw the chart
        });

        // d3.select(".randomize")
        //     .on("click", function () {
        //         change(randomData());
        //     });


        function change(data) {

            /* ------- PIE SLICES -------*/
            var slice = svg.select(".slices").selectAll("path.slice")
                .data(pie(data), key);

            slice.enter()
                .insert("path")
                .style("fill", function (d) { return color(d.data.label); })
                .attr("class", "slice");

            slice
                .transition().duration(1000)
                .attrTween("d", function (d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function (t) {
                        return arc(interpolate(t));
                    };
                })

            slice.exit()
                .remove();

            /* ------- TEXT LABELS -------*/

            var text = svg.select(".labels").selectAll("text")
                .data(pie(data), key);

            text.enter()
                .append("text")
                .attr("dy", ".35em")
                .text(function (d) {
                    return d.data.label;
                });

            function midAngle(d) {
                return d.startAngle + (d.endAngle - d.startAngle) / 2;
            }

            text.transition().duration(1000)
                .attrTween("transform", function (d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function (t) {
                        var d2 = interpolate(t);
                        var pos = outerArc.centroid(d2);
                        pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1);
                        return "translate(" + pos + ")";
                    };
                })
                .styleTween("text-anchor", function (d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function (t) {
                        var d2 = interpolate(t);
                        return midAngle(d2) < Math.PI ? "start" : "end";
                    };
                });

            text.exit()
                .remove();

            /* ------- SLICE TO TEXT POLYLINES -------*/

            var polyline = svg.select(".lines").selectAll("polyline")
                .data(pie(data), key);

            polyline.enter()
                .append("polyline");

            polyline.transition().duration(1000)
                .attrTween("points", function (d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function (t) {
                        var d2 = interpolate(t);
                        var pos = outerArc.centroid(d2);
                        pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
                        return [arc.centroid(d2), outerArc.centroid(d2), pos];
                    };
                });

            polyline.exit()
                .remove();
        };

    </script>
</body>

</html>